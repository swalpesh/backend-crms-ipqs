// src/controllers/roles.controller.js
import { pool } from "../config/db.js";
import { validationResult } from "express-validator";

/**
 * Maps a DB row to API response with department_name visible.
 * Since departments.department_id == departments.department_name, we just alias it.
 */
function mapRoleRow(r) {
  return {
    role_id: r.role_id,
    role_name: r.role_name,
    department_id: r.department_id,
    department_name: r.department_name, // from JOIN
    status: r.status,
    created_at: r.created_at
  };
}

/**
 * POST /api/v1/roles
 * Body: { role_name: string, department_id: string, status?: "active"|"inactive" }
 * - role_id is generated by DB == role_name
 */
export const createRole = async (req, res) => {
  try {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });

    const role_name_raw = req.body.role_name || "";
    const department_id_raw = req.body.department_id || "";
    const status = (req.body.status || "active").trim();

    const role_name = role_name_raw.trim().replace(/\s+/g, " ");
    const department_id = department_id_raw.trim().replace(/\s+/g, " ");

    if (!role_name) return res.status(400).json({ message: "role_name is required" });
    if (!department_id) return res.status(400).json({ message: "department_id is required" });

    // Ensure department exists
    const [dep] = await pool.query(
      `SELECT department_id, department_name FROM departments WHERE department_id = ? LIMIT 1`,
      [department_id]
    );
    if (!dep.length) return res.status(400).json({ message: "Invalid department_id" });

    try {
      await pool.query(
        `INSERT INTO roles (role_name, department_id, status) VALUES (?, ?, ?)`,
        [role_name, department_id, status]
      );

      const [rows] = await pool.query(
        `SELECT r.role_id, r.role_name, r.department_id, r.status, r.created_at,
                d.department_name
         FROM roles r
         JOIN departments d ON d.department_id = r.department_id
         WHERE r.role_id = ?`,
        [role_name]
      );

      return res.status(201).json({
        message: "Role created",
        data: mapRoleRow(rows[0])
      });
    } catch (err) {
      if (err && err.code === "ER_DUP_ENTRY") {
        return res.status(409).json({ message: "Role already exists" });
      }
      console.error(err);
      return res.status(500).json({ message: "Failed to create role" });
    }
  } catch (e) {
    console.error(e);
    return res.status(500).json({ message: "Server error" });
  }
};

/**
 * GET /api/v1/roles
 * Query: ?status=active|inactive (optional) & ?department_id=... (optional)
 */
export const listRoles = async (req, res) => {
  try {
    const { status, department_id } = req.query;
    const args = [];
    const where = [];

    if (status === "active" || status === "inactive") {
      where.push("r.status = ?");
      args.push(status);
    }
    if (department_id) {
      where.push("r.department_id = ?");
      args.push(department_id.trim());
    }

    const sql = `
      SELECT r.role_id, r.role_name, r.department_id, r.status, r.created_at,
             d.department_name
      FROM roles r
      JOIN departments d ON d.department_id = r.department_id
      ${where.length ? "WHERE " + where.join(" AND ") : ""}
      ORDER BY r.role_name ASC
    `;
    const [rows] = await pool.query(sql, args);
    return res.json({ data: rows.map(mapRoleRow) });
  } catch (e) {
    console.error(e);
    return res.status(500).json({ message: "Server error" });
  }
};

/**
 * GET /api/v1/roles/:id
 * id = role_id (== role_name)
 */
export const getRole = async (req, res) => {
  try {
    const id = (req.params.id || "").trim();
    const [rows] = await pool.query(
      `SELECT r.role_id, r.role_name, r.department_id, r.status, r.created_at,
              d.department_name
       FROM roles r
       JOIN departments d ON d.department_id = r.department_id
       WHERE r.role_id = ?`,
      [id]
    );
    if (!rows.length) return res.status(404).json({ message: "Not found" });
    return res.json({ data: mapRoleRow(rows[0]) });
  } catch (e) {
    console.error(e);
    return res.status(500).json({ message: "Server error" });
  }
};

/**
 * PATCH /api/v1/roles/:id
 * Body: { role_name?, department_id?, status? }
 * - If role_name changes, role_id changes too (id == name).
 * - department_id change validated against departments table.
 */
export const updateRole = async (req, res) => {
  try {
    const id = (req.params.id || "").trim();

    // Ensure role exists first (so we can differentiate 404 vs dup)
    const [exists] = await pool.query(`SELECT role_id FROM roles WHERE role_id = ?`, [id]);
    if (!exists.length) return res.status(404).json({ message: "Not found" });

    const updates = [];
    const args = [];

    if (typeof req.body.role_name === "string") {
      const rn = req.body.role_name.trim().replace(/\s+/g, " ");
      if (!rn) return res.status(400).json({ message: "role_name cannot be empty" });
      updates.push("role_name = ?");
      args.push(rn);
    }

    if (typeof req.body.department_id === "string") {
      const did = req.body.department_id.trim().replace(/\s+/g, " ");
      if (!did) return res.status(400).json({ message: "department_id cannot be empty" });

      // Validate department exists
      const [dep] = await pool.query(
        `SELECT department_id FROM departments WHERE department_id = ? LIMIT 1`,
        [did]
      );
      if (!dep.length) return res.status(400).json({ message: "Invalid department_id" });

      updates.push("department_id = ?");
      args.push(did);
    }

    if (req.body.status === "active" || req.body.status === "inactive") {
      updates.push("status = ?");
      args.push(req.body.status);
    }

    if (!updates.length) {
      return res.status(400).json({ message: "No fields to update" });
    }

    args.push(id);

    try {
      const [result] = await pool.query(
        `UPDATE roles SET ${updates.join(", ")} WHERE role_id = ?`,
        args
      );
      if (result.affectedRows === 0) return res.status(404).json({ message: "Not found" });

      // If role_name changed, id changed. Figure out the final id:
      const finalId = typeof req.body.role_name === "string"
        ? req.body.role_name.trim().replace(/\s+/g, " ")
        : id;

      const [rows] = await pool.query(
        `SELECT r.role_id, r.role_name, r.department_id, r.status, r.created_at,
                d.department_name
         FROM roles r
         JOIN departments d ON d.department_id = r.department_id
         WHERE r.role_id = ?`,
        [finalId]
      );

      return res.json({ message: "Updated", data: mapRoleRow(rows[0]) });
    } catch (err) {
      if (err && err.code === "ER_DUP_ENTRY") {
        return res.status(409).json({ message: "Role already exists" });
      }
      console.error(err);
      return res.status(500).json({ message: "Failed to update role" });
    }
  } catch (e) {
    console.error(e);
    return res.status(500).json({ message: "Server error" });
  }
};

/**
 * DELETE /api/v1/roles/:id
 */
export const deleteRole = async (req, res) => {
  try {
    const id = (req.params.id || "").trim();
    const [result] = await pool.query(`DELETE FROM roles WHERE role_id = ?`, [id]);
    if (result.affectedRows === 0) return res.status(404).json({ message: "Not found" });
    return res.json({ message: "Deleted" });
  } catch (e) {
    console.error(e);
    return res.status(500).json({ message: "Server error" });
  }
};


export const listRolesByDepartment = async (req, res) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });

  const deptId = (req.params.deptId || "").trim();

  try {
    const [rows] = await pool.query(
      `SELECT r.role_id, r.role_name, r.department_id, d.department_name, r.created_at, r.status
       FROM roles r
       LEFT JOIN departments d ON d.department_id = r.department_id
       WHERE r.department_id = ?
       ORDER BY r.role_name ASC`,
      [deptId]
    );

    return res.json({ data: rows });
  } catch (err) {
    console.error(err);
    return res.status(500).json({ message: "Server error" });
  }
};

/**
 * GET /api/v1/roles?department_id=...
 * Returns roles optionally filtered by department_id
 */
export const listRoless = async (req, res) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });

  const departmentId = req.query.department_id ? String(req.query.department_id).trim() : null;

  try {
    const where = [];
    const args = [];

    if (departmentId) {
      where.push("r.department_id = ?");
      args.push(departmentId);
    }

    let sql =
      `SELECT r.role_id, r.role_name, r.department_id, d.department_name, r.created_at, r.status
       FROM roles r
       LEFT JOIN departments d ON d.department_id = r.department_id`;

    if (where.length) sql += " WHERE " + where.join(" AND ");
    sql += " ORDER BY d.department_name ASC, r.role_name ASC";

    const [rows] = await pool.query(sql, args);
    return res.json({ data: rows });
  } catch (err) {
    console.error(err);
    return res.status(500).json({ message: "Server error" });
  }
};