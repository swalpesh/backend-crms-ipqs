// src/controllers/departments.controller.js
import { pool } from "../config/db.js";
import { validationResult } from "express-validator";

/**
 * POST /api/v1/departments
 * Body: { department_name: string, status?: "active"|"inactive" }
 * - department_id is generated by DB as equal to department_name
 */
export const createDepartment = async (req, res) => {
  try {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });

    const name = req.body.department_name?.trim();
    const status = (req.body.status || "active").trim();

    // Hard check: id == name rule (we store both but department_id is generated from name)
    if (!name) return res.status(400).json({ message: "department_name is required" });

    // Optional: normalize whitespace
    const department_name = name.replace(/\s+/g, " ");

    try {
      const [result] = await pool.query(
        `INSERT INTO departments (department_name, status)
         VALUES (?, ?)`,
        [department_name, status]
      );

      // Return the row (select by the generated id/name)
      const [rows] = await pool.query(
        `SELECT department_id, department_name, status, created_at FROM departments WHERE department_id = ?`,
        [department_name]
      );

      return res.status(201).json({
        message: "Department created",
        data: rows[0]
      });
    } catch (err) {
      if (err && err.code === "ER_DUP_ENTRY") {
        return res.status(409).json({ message: "Department already exists" });
      }
      console.error(err);
      return res.status(500).json({ message: "Failed to create department" });
    }
  } catch (e) {
    console.error(e);
    return res.status(500).json({ message: "Server error" });
  }
};

/**
 * GET /api/v1/departments
 * Query: ?status=active|inactive (optional)
 */
export const listDepartments = async (req, res) => {
  try {
    const { status } = req.query;
    let sql = `SELECT department_id, department_name, status, created_at FROM departments`;
    const args = [];

    if (status === "active" || status === "inactive") {
      sql += ` WHERE status = ?`;
      args.push(status);
    }
    sql += ` ORDER BY department_name ASC`;

    const [rows] = await pool.query(sql, args);
    return res.json({ data: rows });
  } catch (e) {
    console.error(e);
    return res.status(500).json({ message: "Server error" });
  }
};

/**
 * GET /api/v1/departments/:id
 */
export const getDepartment = async (req, res) => {
  try {
    const id = req.params.id;
    const [rows] = await pool.query(
      `SELECT department_id, department_name, status, created_at FROM departments WHERE department_id = ?`,
      [id]
    );
    if (!rows.length) return res.status(404).json({ message: "Not found" });
    return res.json({ data: rows[0] });
  } catch (e) {
    console.error(e);
    return res.status(500).json({ message: "Server error" });
  }
};

/**
 * PATCH /api/v1/departments/:id
 * Body: { status?: "active"|"inactive", department_name?: string }
 * - If department_name changes, department_id also changes (because it's generated from name).
 */
export const updateDepartment = async (req, res) => {
  try {
    const id = req.params.id;
    const { department_name, status } = req.body;

    // Build update sets
    const sets = [];
    const args = [];

    if (department_name) {
      const cleaned = department_name.trim().replace(/\s+/g, " ");
      sets.push(`department_name = ?`);
      args.push(cleaned);
    }

    if (status === "active" || status === "inactive") {
      sets.push(`status = ?`);
      args.push(status);
    }

    if (!sets.length) {
      return res.status(400).json({ message: "No fields to update" });
    }

    args.push(id);
    try {
      const [result] = await pool.query(
        `UPDATE departments SET ${sets.join(", ")} WHERE department_id = ?`,
        args
      );
      if (result.affectedRows === 0) return res.status(404).json({ message: "Not found" });

      // The id may have changed if department_name changed; fetch the new row by new id
      const finalId = department_name ? department_name.trim().replace(/\s+/g, " ") : id;
      const [rows] = await pool.query(
        `SELECT department_id, department_name, status, created_at FROM departments WHERE department_id = ?`,
        [finalId]
      );
      return res.json({ message: "Updated", data: rows[0] });
    } catch (err) {
      if (err && err.code === "ER_DUP_ENTRY") {
        return res.status(409).json({ message: "Department already exists" });
      }
      console.error(err);
      return res.status(500).json({ message: "Failed to update department" });
    }
  } catch (e) {
    console.error(e);
    return res.status(500).json({ message: "Server error" });
  }
};

/**
 * DELETE /api/v1/departments/:id
 * (hard delete; switch to soft delete if you prefer)
 */
export const deleteDepartment = async (req, res) => {
  try {
    const id = req.params.id;
    const [result] = await pool.query(
      `DELETE FROM departments WHERE department_id = ?`,
      [id]
    );
    if (result.affectedRows === 0) return res.status(404).json({ message: "Not found" });
    return res.json({ message: "Deleted" });
  } catch (e) {
    console.error(e);
    return res.status(500).json({ message: "Server error" });
  }
};
